import React, { useState, useEffect } from 'react';
import { Calculator, Monitor, Settings, Code, AlertCircle, CheckCircle } from 'lucide-react';

const DisplayPortCalculator = () => {
  const [resolution, setResolution] = useState({ width: 4096, height: 2160 });
  const [fps, setFps] = useState(60);
  const [bpp, setBpp] = useState(24);
  const [vPorch, setVPorch] = useState(88);
  const [hPorch, setHPorch] = useState(128);
  const [multiFunc, setMultiFunc] = useState(false);
  const [results, setResults] = useState(null);

  // DisplayPort link configurations
  const linkConfigs = [
    { lanes: 1, rates: [1.62, 2.7, 5.4, 8.1] },
    { lanes: 2, rates: [1.62, 2.7, 5.4, 8.1] },
    { lanes: 4, rates: [1.62, 2.7, 5.4, 8.1] }
  ];

  const calculateMaxDataCapacity = (lanes, rate) => {
    return lanes * rate * 0.8;
  };

  const calculateBandwidth = () => {
    // Calculate pixel clock
    const pixelClock = (resolution.width + vPorch) * (resolution.height + hPorch) * fps / 1000000; // MHz
    
    // Calculate pixel bit rate
    const pixelBitRate = pixelClock * bpp / 1000; // Gbps
    
    // Find suitable configurations
    const suitableConfigs = [];
    
    linkConfigs.forEach(config => {
      let maxLanes = config.lanes;
      if (multiFunc && maxLanes > 2) {
        maxLanes = 2; // USB reserves 2 lanes in multi-function mode
      }
      
      config.rates.forEach(rate => {
        const maxDataCapacity = calculateMaxDataCapacity(maxLanes, rate);
        const isSupported = maxDataCapacity >= pixelBitRate;
        
        suitableConfigs.push({
          lanes: maxLanes,
          rate: rate,
          maxDataCapacity: maxDataCapacity,
          isSupported: isSupported,
          efficiency: isSupported ? (pixelBitRate / maxDataCapacity * 100).toFixed(1) : 'N/A'
        });
      });
    });
    
    // Find the best configuration (lowest lanes, lowest rate that works)
    const supportedConfigs = suitableConfigs.filter(config => config.isSupported);
    const bestConfig = supportedConfigs.reduce((best, current) => {
      if (!best) return current;
      if (current.lanes < best.lanes) return current;
      if (current.lanes === best.lanes && current.rate < best.rate) return current;
      return best;
    }, null);
    
    return {
      pixelClock: pixelClock.toFixed(2),
      pixelBitRate: pixelBitRate.toFixed(3),
      allConfigs: suitableConfigs,
      bestConfig: bestConfig
    };
  };

  useEffect(() => {
    setResults(calculateBandwidth());
  }, [resolution, fps, bpp, vPorch, hPorch, multiFunc]);

  const presetResolutions = [
    { name: '4K UHD', width: 3840, height: 2160 },
    { name: '4K Cinema', width: 4096, height: 2160 },
    { name: '1440p', width: 2560, height: 1440 },
    { name: '1080p', width: 1920, height: 1080 },
    { name: '8K UHD', width: 7680, height: 4320 }
  ];

  return (
    <div className="max-w-6xl mx-auto p-6 bg-gray-50 min-h-screen">
      {/* Header */}
      <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div className="flex items-center gap-3 mb-4">
          <Monitor className="h-8 w-8 text-blue-600" />
          <div>
            <h1 className="text-2xl font-bold text-gray-800">DisplayPort Bandwidth Calculator</h1>
            <p className="text-gray-600">KBA-180328203103 - Calculate link requirements and explore DP workflow</p>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Input Panel */}
        <div className="lg:col-span-1">
          <div className="bg-white rounded-lg shadow-lg p-6">
            <div className="flex items-center gap-2 mb-4">
              <Calculator className="h-5 w-5 text-blue-600" />
              <h2 className="text-lg font-semibold">Configuration</h2>
            </div>
            
            {/* Preset Resolutions */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">Quick Presets</label>
              <div className="grid grid-cols-2 gap-2">
                {presetResolutions.map(preset => (
                  <button
                    key={preset.name}
                    onClick={() => setResolution({ width: preset.width, height: preset.height })}
                    className="px-3 py-2 text-xs bg-blue-100 hover:bg-blue-200 rounded transition-colors"
                  >
                    {preset.name}
                  </button>
                ))}
              </div>
            </div>

            {/* Resolution */}
            <div className="grid grid-cols-2 gap-3 mb-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Width</label>
                <input
                  type="number"
                  value={resolution.width}
                  onChange={(e) => setResolution({...resolution, width: parseInt(e.target.value) || 0})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Height</label>
                <input
                  type="number"
                  value={resolution.height}
                  onChange={(e) => setResolution({...resolution, height: parseInt(e.target.value) || 0})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>

            {/* Other parameters */}
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Refresh Rate (fps)</label>
                <input
                  type="number"
                  value={fps}
                  onChange={(e) => setFps(parseInt(e.target.value) || 0)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Bits per Pixel (bpp)</label>
                <select
                  value={bpp}
                  onChange={(e) => setBpp(parseInt(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value={18}>18 bpp</option>
                  <option value={24}>24 bpp</option>
                  <option value={30}>30 bpp</option>
                  <option value={36}>36 bpp</option>
                </select>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">V Porch</label>
                  <input
                    type="number"
                    value={vPorch}
                    onChange={(e) => setVPorch(parseInt(e.target.value) || 0)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">H Porch</label>
                  <input
                    type="number"
                    value={hPorch}
                    onChange={(e) => setHPorch(parseInt(e.target.value) || 0)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>

              <div className="flex items-center gap-2">
                <input
                  type="checkbox"
                  id="multiFunc"
                  checked={multiFunc}
                  onChange={(e) => setMultiFunc(e.target.checked)}
                  className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                />
                <label htmlFor="multiFunc" className="text-sm text-gray-700">
                  Multi-function mode (USB + DP)
                </label>
              </div>
            </div>
          </div>
        </div>

        {/* Results Panel */}
        <div className="lg:col-span-2">
          <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 className="text-lg font-semibold mb-4">Calculation Results</h2>
            
            {results && (
              <div className="space-y-4">
                {/* Summary */}
                <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                  <div>
                    <div className="text-sm text-gray-600">Pixel Clock</div>
                    <div className="text-lg font-semibold">{results.pixelClock} MHz</div>
                  </div>
                  <div>
                    <div className="text-sm text-gray-600">Required Bandwidth</div>
                    <div className="text-lg font-semibold">{results.pixelBitRate} Gbps</div>
                  </div>
                </div>

                {/* Best Configuration */}
                {results.bestConfig && (
                  <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <div className="flex items-center gap-2 mb-2">
                      <CheckCircle className="h-5 w-5 text-green-600" />
                      <h3 className="font-semibold text-green-800">Recommended Configuration</h3>
                    </div>
                    <div className="grid grid-cols-3 gap-4 text-sm">
                      <div>
                        <span className="text-gray-600">Lanes:</span> {results.bestConfig.lanes}
                      </div>
                      <div>
                        <span className="text-gray-600">Rate:</span> {results.bestConfig.rate} Gbps
                      </div>
                      <div>
                        <span className="text-gray-600">Efficiency:</span> {results.bestConfig.efficiency}%
                      </div>
                    </div>
                  </div>
                )}

                {/* All Configurations Table */}
                <div>
                  <h3 className="font-semibold mb-3">All Link Configurations</h3>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="bg-gray-100">
                          <th className="px-3 py-2 text-left">Lanes</th>
                          <th className="px-3 py-2 text-left">Rate (Gbps)</th>
                          <th className="px-3 py-2 text-left">Max Capacity (Gbps)</th>
                          <th className="px-3 py-2 text-left">Status</th>
                          <th className="px-3 py-2 text-left">Efficiency</th>
                        </tr>
                      </thead>
                      <tbody>
                        {results.allConfigs.map((config, index) => (
                          <tr key={index} className={`border-b ${config.isSupported ? 'bg-green-50' : 'bg-red-50'}`}>
                            <td className="px-3 py-2">{config.lanes}</td>
                            <td className="px-3 py-2">{config.rate}</td>
                            <td className="px-3 py-2">{config.maxDataCapacity.toFixed(2)}</td>
                            <td className="px-3 py-2">
                              <span className={`px-2 py-1 rounded text-xs ${
                                config.isSupported 
                                  ? 'bg-green-100 text-green-800' 
                                  : 'bg-red-100 text-red-800'
                              }`}>
                                {config.isSupported ? 'Supported' : 'Insufficient'}
                              </span>
                            </td>
                            <td className="px-3 py-2">{config.efficiency}%</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Workflow Section */}
          <div className="bg-white rounded-lg shadow-lg p-6">
            <div className="flex items-center gap-2 mb-4">
              <Settings className="h-5 w-5 text-blue-600" />
              <h2 className="text-lg font-semibold">DisplayPort Workflow</h2>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h3 className="font-semibold mb-3 text-blue-800">Kernel Level Functions</h3>
                <div className="space-y-2 text-sm">
                  <div className="p-2 bg-blue-50 rounded">dp_display_probe</div>
                  <div className="p-2 bg-blue-50 rounded">dp_display_create_workqueue</div>
                  <div className="p-2 bg-blue-50 rounded">dp_display_enable</div>
                  <div className="p-2 bg-blue-50 rounded">dp_ctrl_on</div>
                  <div className="p-2 bg-blue-50 rounded">dp_ctrl_setup_main_link</div>
                  <div className="p-2 bg-blue-50 rounded">dp_ctrl_link_train</div>
                  <div className="p-2 bg-gray-50 rounded border-l-4 border-orange-500">
                    <strong>Event:</strong> DP_LINK_STATUS_UPDATED
                  </div>
                  <div className="p-2 bg-orange-50 rounded">dp_ctrl_link_rate_down_shift</div>
                </div>
              </div>
              
              <div>
                <h3 className="font-semibold mb-3 text-green-800">HAL Level Functions</h3>
                <div className="space-y-2 text-sm">
                  <div className="p-2 bg-green-50 rounded">HWDeviceDRM::PopulateDisplayAttributes</div>
                  <div className="p-2 bg-green-50 rounded">DisplayHDMI::GetBestConfig</div>
                </div>
                
                <h3 className="font-semibold mb-3 mt-6 text-purple-800">Debug Commands</h3>
                <div className="space-y-2 text-sm">
                  <div className="p-2 bg-gray-900 text-green-400 rounded font-mono">
                    echo 8 > /proc/sys/kernel/printk
                  </div>
                  <div className="p-2 bg-gray-900 text-green-400 rounded font-mono">
                    echo -n "file dp_*.c +p" > /sys/kernel/debug/dynamic_debug/control
                  </div>
                </div>
              </div>
            </div>
            
            <div className="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <div className="flex items-start gap-2">
                <AlertCircle className="h-5 w-5 text-yellow-600 mt-0.5" />
                <div className="text-sm">
                  <strong>Multi-function Mode:</strong> When USB-C multi-function is enabled, 
                  USB reserves 2 lanes for SuperSpeed, limiting DisplayPort to maximum 2 lanes. 
                  The system automatically adjusts lane count based on DPCD capabilities.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default DisplayPortCalculator;
